<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RESET Summit 2025 - AMS</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='styles.css') }}"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="container">
      <h1>RESET Summit 2025 Participant Information</h1>
      <label for="search-input"
        ><strong>Search Participants Name</strong></label
      >

      <div class="search-container">
        <input
          type="text"
          id="search-input"
          placeholder="Start typing participant name..."
          autocomplete="off"
        />
        <div id="suggestions-container" class="suggestions-container"></div>
      </div>

      <div id="result"></div>
    </div>

    <div id="imageModal" class="modal" onclick="closeModal(event)">
      <span class="close" onclick="closeModal(event)">&times;</span>
      <div id="modalContent"></div>
    </div>

    <script>
      // Variables for controlling search timing
      let debounceTimeout;
      const debounceTime = 300; // ms

      // Search input event listener
      // Search input event listener
      document
        .getElementById("search-input")
        .addEventListener("input", function () {
          clearTimeout(debounceTimeout);
          const query = this.value.trim();

          // Clear and hide suggestions container if query is too short
          if (query.length < 2) {
            document.getElementById("suggestions-container").innerHTML = "";
            document.getElementById("suggestions-container").style.display =
              "none";
            return;
          }

          // Set display to block BEFORE fetching suggestions
          document.getElementById("suggestions-container").style.display =
            "block";
          document.getElementById("suggestions-container").innerHTML =
            "<div class='suggestion-item'>Loading...</div>";

          debounceTimeout = setTimeout(() => {
            fetchSuggestions(query);
          }, debounceTime);
        });

      // Fetch search suggestions as user types
      function fetchSuggestions(query) {
        fetch(`/search_suggestions?query=${encodeURIComponent(query)}`)
          .then((response) => response.json())
          .then((suggestions) => {
            displaySuggestions(suggestions);
          })
          .catch((error) => {
            console.error("Error fetching suggestions:", error);
          });
      }

      // Display suggestions in dropdown
      function displaySuggestions(suggestions) {
        const suggestionsContainer = document.getElementById(
          "suggestions-container"
        );

        if (suggestions.length === 0) {
          suggestionsContainer.innerHTML =
            "<div class='suggestion-item'>No results found</div>";
          suggestionsContainer.style.display = "block";
          return;
        }

        let suggestionsHTML = "";
        suggestions.forEach((suggestion) => {
          suggestionsHTML += `
            <div class="suggestion-item" 
                 data-submission-id="${suggestion.submission_id}"
                 data-first-name="${suggestion.first_name}"
                 data-middle-name="${suggestion.middle_name}"
                 data-last-name="${suggestion.last_name}">
              ${suggestion.name}
            </div>
          `;
        });

        suggestionsContainer.innerHTML = suggestionsHTML;
        suggestionsContainer.style.display = "block";

        // Add click event listeners to suggestions
        document.querySelectorAll(".suggestion-item").forEach((item) => {
          item.addEventListener("click", function () {
            const submissionId = this.getAttribute("data-submission-id");
            // If using submission ID approach:
            if (submissionId) {
              fetchParticipantDetails(submissionId);
            } else {
              // Fallback to name-based search
              const firstName = this.getAttribute("data-first-name");
              const middleName = this.getAttribute("data-middle-name");
              const lastName = this.getAttribute("data-last-name");
              fetchParticipantDetailsByName(firstName, middleName, lastName);
            }

            // Clear search and suggestions
            document.getElementById("search-input").value =
              this.textContent.trim();
            document.getElementById("suggestions-container").style.display =
              "none";
          });
        });
      }

      // Fetch participant details by submission ID
      function fetchParticipantDetails(submissionId) {
        fetch(`/search?submission_id=${encodeURIComponent(submissionId)}`)
          .then((response) => response.json())
          .then((data) => {
            displayParticipantDetails(data);
          })
          .catch((error) => {
            console.error("Error fetching attendee details:", error);
            document.getElementById("result").innerHTML =
              "<p style='color: red;'>An error occurred while fetching details. Please try again.</p>";
          });
      }

      // Fallback: Fetch participant details by name
      function fetchParticipantDetailsByName(firstName, middleName, lastName) {
        fetch(
          `/search?first_name=${encodeURIComponent(
            firstName
          )}&middle_name=${encodeURIComponent(
            middleName
          )}&last_name=${encodeURIComponent(lastName)}`
        )
          .then((response) => response.json())
          .then((data) => {
            displayParticipantDetails(data);
          })
          .catch((error) => {
            console.error("Error fetching attendee details:", error);
            document.getElementById("result").innerHTML =
              "<p style='color: red;'>An error occurred while fetching details. Please try again.</p>";
          });
      }

      // Display participant details (same as your original code)
      function displayParticipantDetails(data) {
        let resultDiv = document.getElementById("result");
        if (data.error) {
          resultDiv.innerHTML = `<p style="color: red;">${data.error}</p>`;
        } else {
          resultDiv.innerHTML = `
          <div class="details-container">
            <div class="details-column">
              <h3>Personal Details</h3>
              <p><strong>First Name:</strong> ${data["First Name"]}</p>
              <p><strong>Middle Name:</strong> ${data["Middle Name"]}</p>
              <p><strong>Last Name:</strong> ${data["Last Name"]}</p>
              <p><strong>Full Name:</strong> ${data["Full Name"]}</p>
              <p><strong>Email Address:</strong> ${data["Email Address"]}</p>
              <p><strong>Room Type:</strong> ${data["Room Type"]}</p>
              <p><strong>Departure Date:</strong> ${data["Departure Date"]}</p>
              <p><strong>Return Date:</strong> ${data["Return Date"]}</p>
              <p><strong>Delegates Role:</strong> ${data["Delegates Role"]}</p>
            </div>
            
            <div class="details-column">
              <h3>Emergency Contact Details</h3>
              <p><strong>Emergency Contact First Name:</strong> ${
                data["Emergency Contact First Name"]
              }</p>
              <p><strong>Emergency Contact Last Name:</strong> ${
                data["Emergency Contact Last Name"]
              }</p>
              <p><strong>Emergency Contact Number:</strong> ${
                data["Emergency Contact Phone"]
              }</p>
              <p><strong>Relationship to Emergency Contact:</strong> ${
                data["Emergency Contact Relationship"]
              }</p>
            </div>

            <div class="details-column">
              <h3>Health & Dietary Information</h3>
              <p><strong>Food Allergies and Dietary Restrictions:</strong> ${
                data["Food Allergies and Dietary Restrictions"]
              }</p>
              <p><strong>Medical Conditions:</strong> ${
                data["Medical Conditions"]
              }</p>
              <p><strong>Accessibility Needs:</strong> ${
                data["Accessibility Needs"]
              }</p>
            </div>

            <div class="details-column">
              <h3>Consent & Privacy</h3>
              <p><strong>Consent to Privacy Policy:</strong> ${
                data["Consent Privacy Policy"]
              }</p>
              <p><strong>Photography & Video Consent:</strong> ${
                data["Consent Photography"]
              }</p>
            </div>

            <div class="payment-column">
              <h3>Proof of Payment for Upgraded Rooms</h3>
              ${
                data["Proof of Payment URL"]
                  ? `<div class="payment-details-container">
                        <a href="${data["Proof of Payment URL"]}" class="download-btn" target="_blank">Download Proof of Payment</a>
                        <button class="view-btn" onclick="openModal('${data["Proof of Payment URL"]}')">View Proof of Payment</button>
                      </div>`
                  : "<p>No Proof of Payment Available.</p>"
              }
            </div>

          </div>

          <div id="passport-section">
            <h3>Passport Image</h3>
            ${
              data["Passport URL"]
                ? `<button id="view-passport">View Passport</button>
                  <div id="passport-container" style="display: none; text-align: center;">
                    <input type="password" id="passport-key" placeholder="Enter Passcode">
                    <button id="submit-passport-key">Submit</button>
                    <br>
                    <img id="passport-image" src="${data["Passport URL"]}" width="200px" style="display: none; border-radius: 10%; cursor: pointer; margin: auto;" onclick="openModal(this.src)">
                  </div>`
                : "<p>No Passport Image Available.</p>"
            }
          </div>

          <div class="details-column">
            <h3>Flight Details</h3>
            ${
              data["Flight Details URL"]
                ? `
                  <div class="flight-details-container">
                    <a href="${data["Flight Details URL"]}" class="download-btn" target="_blank">Download Flight Details</a>
                    <button class="view-btn" onclick="openModal('${data["Flight Details URL"]}')">View Flight Details</button>
                  </div>
                  <div class="flight-info">
                    <h4>Arrival Flight Information</h4>
                    <p><strong>Airline:</strong> ${data["Airline (Arrival)"]}</p>
                    <p><strong>Flight Number:</strong> ${data["Flight Number (Arrival)"]}</p>
                    <p><strong>Country of Origin:</strong> ${data["Country of Origin"]}</p>
                    <p><strong>Departure Time:</strong> ${data["Departure Time (Arrival)"]}</p>
                    <p><strong>Arrival Time in Bali:</strong> ${data["Arrival Time in Bali"]}</p>
                  </div>
                  <div class="flight-info">
                    <h4>Departure Flight Information</h4>
                    <p><strong>Airline:</strong> ${data["Airline (Departure)"]}</p>
                    <p><strong>Flight Number:</strong> ${data["Flight Number (Departure)"]}</p>
                    <p><strong>Departure Time:</strong> ${data["Departure Time (Departure)"]}</p>
                  </div>
                `
                : `
                  <p>No Flight Details Available.</p>
                  <div class="flight-info">
                    <h4>Arrival Flight Information</h4>
                    <p><strong>Airline:</strong> ${data["Airline (Arrival)"]}</p>
                    <p><strong>Flight Number:</strong> ${data["Flight Number (Arrival)"]}</p>
                    <p><strong>Country of Origin:</strong> ${data["Country of Origin"]}</p>
                    <p><strong>Departure Time:</strong> ${data["Departure Time (Arrival)"]}</p>
                    <p><strong>Arrival Time in Bali:</strong> ${data["Arrival Time in Bali"]}</p>
                  </div>
                  <div class="flight-info">
                    <h4>Departure Flight Information</h4>
                    <p><strong>Airline:</strong> ${data["Airline (Departure)"]}</p>
                    <p><strong>Flight Number:</strong> ${data["Flight Number (Departure)"]}</p>
                    <p><strong>Departure Time:</strong> ${data["Departure Time (Departure)"]}</p>
                  </div>
                `
            }
          </div>

        `;

          // Setup passport view button
          if (data["Passport URL"]) {
            document
              .getElementById("view-passport")
              .addEventListener("click", function () {
                document.getElementById("passport-container").style.display =
                  "block";
              });

            document
              .getElementById("submit-passport-key")
              .addEventListener("click", function () {
                let enteredKey = document.getElementById("passport-key").value;
                fetch("/validate_passcode", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ passcode: enteredKey }),
                })
                  .then((response) => response.json())
                  .then((responseData) => {
                    if (responseData.status === "success") {
                      let passportImage =
                        document.getElementById("passport-image");
                      let storedPassportUrl = data["Passport URL"];
                      if (storedPassportUrl) {
                        passportImage.src = storedPassportUrl;
                        passportImage.style.display = "block";
                      } else {
                        alert("No matching Passport file found.");
                      }
                    } else {
                      alert("Incorrect passcode!");
                    }
                  });
              });
          }
        }
      }

      // Modal functions (unchanged)
      function openModal(fileUrl) {
        let modalContent = document.getElementById("modalContent");

        if (fileUrl.endsWith(".pdf")) {
          modalContent.innerHTML = `
            <iframe src="${fileUrl}" width="100%" height="500px"></iframe>
            <a href="${fileUrl}" target="_blank" class="download-btn">Download PDF</a>
          `;
        } else {
          modalContent.innerHTML = `<img src="${fileUrl}" style="max-width: 100%; border-radius: 10px;" />`;
        }

        document.getElementById("imageModal").classList.add("show");
      }

      function closeModal(event) {
        if (
          event.target === document.getElementById("imageModal") ||
          event.target.classList.contains("close")
        ) {
          document.getElementById("imageModal").classList.remove("show");
        }
      }

      // Close suggestions when clicking outside
      document.addEventListener("click", function (event) {
        if (!event.target.closest(".search-container")) {
          document.getElementById("suggestions-container").style.display =
            "none";
        }
      });
    </script>
  </body>
</html>
